# 依存関係逆転の原則

- 上位モジュールが下位モジュールに依存してはいけない
- 上位モジュールも下位モジュールも抽象に依存する

普通にプログラミングすると、上位モジュールが下位モジュールに依存してしまう。  

なぜ？  
- 抽象は変わりづらく、詳細は変わりやすい

例えば:  
抽象：新規の顧客情報を読み込んで、保存する  
詳細：元の実装）新規の顧客情報をcsvから読み込んで、HDDにcsvで保存する  
　　　数年後の実装）新規の顧客情報をjsonから読み込んで、サーバー上のDBに保存する  

また、開発中によく問題になるパターンとして:  
- 実機がないと動かない
- サーバーが動いていないと動かない

## 原則を守るための解決法

- Interfaceを挟むことで抽象に依存させる
- Factory パターンやFactory Method パターンなどで下位モジュールを生成する

## メリット

- モックやテストデータが作りやすくなる
- 下位モジュールが抽象に依存することで、下位モジュールはメソッド（機能）の実装が強制される。抽象で仕様を表現することが出来る

## アンチパターン（やりがちな実装）

クライアントで、サブクラスの判定をしてサブクラスごとの呼び分けをしてしまう。

## 依存性の注入（DI）

Interfaceに依存した下位モジュールのインスタンスを上位モジュールで生成し、Interfaceに依存して処理する。  

メリット：テスト（単体テスト）がやりやすくなる  
デメリット：テストを書かない場合は実装が冗長になり、可読性が落ちる  

## まとめ

- 抽象（インターフェース）に対してコーディングする。クライアントの要求を抽象で書く。
- 原則にすべて従うと作れなくなる。どこかで必ずnewする場所がある。  
  原則にすべて従うのではなく、従うことを心がける。忘れない。
- 変化しないもの、ほぼしないものは許容する。

## 原則に従うべきかの判断基準

- テストコードがうまく書けるかどうか。  
　依存性を注入しないとテストコードを書けない場合は採用する。
