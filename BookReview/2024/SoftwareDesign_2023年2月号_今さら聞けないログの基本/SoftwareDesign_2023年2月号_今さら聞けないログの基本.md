date:2024年5月  

雑誌『Software Design 2023年2月号』  
第2特集　開発者も知っておきたい 今さら聞けないログの基本  
https://gihyo.jp/magazine/SD/archive/2023/202302  

注：特定の環境（LinuxやWebサーバー）については除いて、まとめてあります。  

---

＜目次＞  

- [ログとは](#ログとは)
  - [ログの管理方法](#ログの管理方法)
  - [ログの扱いで注意する点](#ログの扱いで注意する点)
    - [ログファイルを分ける](#ログファイルを分ける)
    - [時刻同期とタイムゾーンの設定](#時刻同期とタイムゾーンの設定)
- [ロギング設計の基本](#ロギング設計の基本)
  - [ログ設計の概要](#ログ設計の概要)
    - [ログの設計とは何か](#ログの設計とは何か)
    - [なぜログを設計するのか](#なぜログを設計するのか)
  - [ログを設計する前に確認すること](#ログを設計する前に確認すること)
  - [ログを設計する方法](#ログを設計する方法)
    - [1. どのようなフォーマットにするか](#1-どのようなフォーマットにするか)
    - [2. どのようなメッセージを書くか](#2-どのようなメッセージを書くか)
    - [3. どのログレベルにするか](#3-どのログレベルにするか)
  - [ログを設計するときに気をつけること](#ログを設計するときに気をつけること)
    - [1. 機密情報を出力しない](#1-機密情報を出力しない)
    - [2. 不要な情報を出力しない](#2-不要な情報を出力しない)
      - [ログのサイズの肥大化](#ログのサイズの肥大化)
      - [調査時のノイズになる](#調査時のノイズになる)
      - [システムのパフォーマンスが低下する](#システムのパフォーマンスが低下する)
  - [最後に](#最後に)

---

# ログとは

システムを開発したり運用したりしているとさまざまな問題が生じます。この問題の解決の糸口になるのが「ログ」です。  
ログは、「システムのそのときの状況を読み手に伝えるための記録」です。ログは障害時の調査という目的以外にも、ユーザーの利用状況を分析するときなど、いろんなところで必要になります。  

## ログの管理方法

- OS側で提供されているログ管理システム
- アプリケーションによる独自管理

## ログの扱いで注意する点

調査時にログの内容で困らないように注意する点は以下のようになります。  

### ログファイルを分ける

ログを調査する際には対象のログは少ないほうが調査にかかる時間を短縮できるため、ログファイルを分けるようにします。  

### 時刻同期とタイムゾーンの設定

ログを調査する際にその現象が起きた時刻を特定するときはよくあります。たとえば、OSが一日に一度だけ決まった時刻に処理をするタイミングでのみ不具合が発生してしまう、などがあります。この時に、ログの時刻が正しく出力されていないと、調査する際に困ります。  
サーバーの時刻同期やタイムゾーンの設定をただしく行いましょう。  

# ロギング設計の基本

ログに出力するべき情報やわかりやすいログメッセージの書き方などを通じて、ログの読み手のことを意識した使いやすいログについて理解できます。  

## ログ設計の概要

### ログの設計とは何か

ログの設計とは、どのような情報をログとして出力するのか、その形式や内容を決めることをいいます。  
たとえば、システムに障害が起きたときに運用担当者が調査をするとします。調査のためのログに、どんな情報をログとして出力しておくのかを決めることがログの設計になります。  

### なぜログを設計するのか

ログを設計する目的は、ログの用途に応じた役割をきちんと果たすためです。

## ログを設計する前に確認すること

- ログの用途は何か
- ログの読者は誰か
- 満たすべき要件はないか

## ログを設計する方法

ログの用途・読者・要件を確認したら、ログを設計する準備が整ったことになります。次は、以下のようにログを設計していきます。  

1. どのようなフォーマットにするか
2. どのようなメッセージを書くか
3. どのログレベルにするか

### 1. どのようなフォーマットにするか

下記は、ログに出力する情報の候補です。  

| 候補 | 概要 |
| ---- | ---- |
| 日時 | ログに出力した時間。年月日時分秒、必要ならミリ秒まで |
| リクエストID | リクエストごとに付与される情報 |
| ログレベル | ログレベル。INFOやWARNなど |
| イベントの種類 | どのイベントに関するログか。たとえばログインなど |
| ユーザー情報 | ユーザーを識別する情報。ユーザーIDやIPアドレスなど |
| 関連するリソースの情報 | 通販における注文IDなど |
| 処理の結果 | 成功または失敗 |
| メッセージ | 任意の文章。エラーメッセージなど |

### 2. どのようなメッセージを書くか

メッセージは、状況を読み手に伝えるうえで大きな役割を果たします。メッセージによって、良いログにも良くないログにもなり得ます。運用時に調査をするのがその機能を開発した人ならまだしも、運用担当者はシステムに詳しくないかもしれません。この場合はもっと時間がかかってしまいます。

調査に時間がかかってしまうメッセージの例  
```
2022-12-14 11:06:03.415 user=123 注文に失敗しました。
```
この例では、どの注文が失敗したのか分かりません。  

注文IDを追加し、改善してみます  
```
2022-12-14 11:06:03.415 user=123 order=456 注文に失敗しました。
```
さらに改善してみましょう  
```
2022-12-14 11:06:03.415 user=123 order=456 item=789 商品に在庫がなかったため、注文に失敗しました。
```

ログのメッセージとして、問題の原因が分かる答えを書きます。  
上記の例では、さらに良いメッセージにするには、ユーザーの発注数や在庫数を出力するなども考えられます。こうすれば、より具体的な原因がわかります。  

一方で、ログに必要以上の情報を出力すると、ログのサイズが大きくなったり、問題が起きたときの調査のノイズになったりするかもしれません。  

ログにはいろんな情報を詰め込むのではなく、必要最低限にするのも、ログの設計のポイントの1つです。  
また、ログは基本的には英字にした方が良いでしょう。ログを見る環境によっては、文字エンコーディングの問題でメッセージを正しく表示できない可能性があるためです。メッセージの言語についても、ログの用途や読者によって決めましょう。  

### 3. どのログレベルにするか

ログのフォーマットの中に、ログレベルという項目があります。これは「INFO」や「WARN」のように、そのログがどういう情報なのかを示すものです。  
どのような情報をどのログレベルにするかは、プロジェクトによって異なります。一般的に、本番環境においてはINFOレベル以上、開発環境ではDEBUGレベルも含めてログを出力します。基本的な考え方としては、「INFOレベル以上で、システムがどのような処理をしたのかがわかるようにすること」になります。  

ログレベルの分け方の例  

| レベル | 概要 |
| ---- | ---- |
| FATAL | システムを運用できないような、早急な対応が必要なもの |
| ERROR | 正常に処理できなかったが、システムの運用に大きな影響はないもの |
| WARN | システムは提供できるが、対応が望まれるもの |
| INFO | どのような処理をしたのかがわかる情報 |
| DEBUG | 開発やデバッグに役立つ情報。本番環境では出力しない |

本番環境では、ERROR以上のログレベルが発生した場合には開発者や運用担当者にチャットツールや電話で通知し、早急な対応を求める場合もあります。  

ログレベルを決めるときの良くない例として、次のようなものがあります。  

- システムがどのような処理をしているのかをINFOレベルで出力していない
- 開発者や運用担当者による対応が必要なログなのに、INFOレベルにしている

ログの用途に対する役割を果たせないことになります。

## ログを設計するときに気をつけること

1. 機密情報を出力しない
2. 不要な情報を出力しない

### 1. 機密情報を出力しない

パスワードなどの機密情報を出力してしまうと、そこから情報漏洩につながってりします。「ログは開発者や運用担当者しか見ないから問題ない」と思うかもしれません。ただ、第三者による不正なアクセスや、開発者や運用担当者など内部の人によるログの流出もあり得ます。このような問題を防ぐためにも、次のような情報はログに出力しないようにします。  

- 氏名や住所、電話番号
- メールアドレスやパスワード、アクセストークン
- クレジットカードの番号や有効期限

仮にログに出力するとしても、マスク処理によって情報がわからないようにする必要があります。  

### 2. 不要な情報を出力しない

役立つログにするために、いろんな情報をたくさん出力したくなるかもしれません。ただ、用途に不要な情報は、できるだけ出力しないようにします。不要な情報を出力すると、次のような問題につながります。  

#### ログのサイズの肥大化

ログに出力する情報が多いと、ログのサイズが大きくなります。これによってログの出力先のストレージを逼迫し、コストの増加につながります。  
また、調査するためにログファイルを開こうとして、PCのメモリを多く消費（最悪開けない）してしまうなど、調査担当者の作業効率をを落としてしまうことになります。  

#### 調査時のノイズになる

ログに情報がたくさんあると、問題の解決につながる材料は増えますが、どれが本当に重要なのかがわからなくなってしまいます。情報はあるだけいい、というわけではありません。ログの用途と読者をふまえて、必要な情報のみを出力しましょう。  

#### システムのパフォーマンスが低下する

ログを出力することもシステムの処理の一部ですので、少なからずシステムのパフォーマンスに影響します。特に繰り返し処理の中でログを出力したりすると、システムのパフォーマンスが低下するかもしれません。  

## 最後に

実際にシステムを運用するとなると、どういうときにログを出力すべきか、いくつかのログを横断して分析するにはどうすればいいのか、など知っておくべきことはほかにもあります。

